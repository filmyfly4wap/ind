<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRM MPD Player Â· 4K Â· Multiâ€‘Audio Â· ClearKey</title>
    <!-- dashjs all-in-one -->
    <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
    <!-- Material Icons (custom UI) -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* ----- GLOBAL DARK THEME ----- */
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
        }

        body {
            background: radial-gradient(circle at 20% 30%, #0b0c0e, #030405);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            
        }

        /* ----- CUSTOM PLAYER CONTAINER ----- */
        .player-wrapper {
            position: relative;
            width: 100%;
            max-width: 100%;
            
            background: #000;
            box-shadow: 0 20px 40px rgba(0,0,0,0.8);
            overflow: hidden;
            transition: all 0.2s ease;
            border: 1px solid rgba(255,215,0,0.2);
        }

        .video-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16 / 9;
            background: #000;
        }

        video {
            width: 100%;
            height: 100%;
            display: block;
            pointer-events: none;  /* controls are custom, but we keep native for fallback */
        }

        /* ----- CUSTOM CONTROLS LAYER (glassmorphism) ----- */
        .custom-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0.4), transparent);
            padding: 16px 20px 18px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            color: white;
            opacity: 0;
            transition: opacity 0.25s;
            backdrop-filter: blur(6px);
            border-top: 1px solid rgba(255,215,0,0.5);
        }

        .player-wrapper:hover .custom-controls,
        .custom-controls:active {
            opacity: 1;
        }

        /* progress bar container */
        .seek-section {
            order: 0;
            width: 100%;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 4px;
        }

        .time-display {
            font-size: 0.85rem;
            font-weight: 500;
            letter-spacing: 0.5px;
            color: #ffe28c;
            min-width: 130px;
            text-shadow: 0 0 4px black;
        }

        .seek-bar {
            flex: 1;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            cursor: pointer;
            position: relative;
            transition: height 0.1s;
        }

        .seek-bar:hover {
            height: 8px;
        }

        .seek-progress {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ffd966, #ffaa33);
            border-radius: 10px;
            position: relative;
            box-shadow: 0 0 8px #ffb347;
        }

        /* buttons row */
        .button-row {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            width: 100%;
        }

        .control-btn {
            background: transparent;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px;
            border-radius: 50%;
            transition: all 0.2s;
            background: rgba(20,20,20,0.6);
            backdrop-filter: blur(2px);
        }

        .control-btn:hover {
            background: rgba(255,215,0,0.3);
            color: #ffd966;
            transform: scale(1.1);
        }

        /* quality dropdown + drm badge */
        .select-menu {
            background: rgba(0,0,0,0.8);
            color: #fff;
            border: 1px solid #ffd966;
            border-radius: 30px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            backdrop-filter: blur(4px);
            outline: none;
        }

        .select-menu option {
            background: #111;
            color: #eee;
        }

        .drm-badge {
            background: rgba(255,215,0,0.15);
            border-left: 3px solid #ffd966;
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 12px;
            color: #ffe082;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
        }

        .pip-btn, .fullscreen-btn {
            font-size: 22px;
        }

        .volume-slider {
            width: 80px;
            height: 5px;
            background: rgba(255,255,255,0.3);
            border-radius: 5px;
            accent-color: #ffc107;
        }

        /* live badge */
        .live-tag {
            background: #e50914;
            color: white;
            font-size: 12px;
            font-weight: bold;
            padding: 4px 10px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        /* fullscreen custom style */
        .player-wrapper.fullscreen {
            max-width: 100%;
            max-height: 100vh;
            border-radius: 0;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>

<div class="player-wrapper" id="playerWrapper">
    <!-- Video element -->
    <div class="video-container">
        <video id="videoPlayer" playsinline webkit-playsinline>
            <!-- native controls disabled, we build custom -->
        </video>
    </div>

    <!-- ---------- CUSTOM CONTROL BAR ---------- -->
    <div class="custom-controls" id="customControls">
        <!-- SEEK BAR + TIME -->
        <div class="seek-section">
            <span class="time-display" id="timeDisplay">00:00 / 00:00</span>
            <div class="seek-bar" id="seekBar">
                <div class="seek-progress" id="seekProgress"></div>
            </div>
            <!-- LIVE indicator (if live) -->
            <span class="live-tag" id="liveIndicator" style="display: none;">ðŸ”´ LIVE</span>
        </div>

        <!-- BUTTON ROW (play, volume, quality, audio, pip, fullscreen, DRM) -->
        <div class="button-row">
            <!-- play/pause -->
            <button class="control-btn" id="playPauseBtn" title="Play/Pause">
                <span class="material-icons">play_arrow</span>
            </button>

            <!-- volume slider + mute toggle -->
            <button class="control-btn" id="muteBtn" title="Mute">
                <span class="material-icons">volume_up</span>
            </button>
            <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.05" value="1">

            <!-- QUALITY selector (auto + manual) -->
            <select id="qualitySelector" class="select-menu" title="Video Quality">
                <option value="auto">ðŸ”¹ Auto (adaptive)</option>
            </select>

            <!-- Multi-language audio track -->
            <select id="audioTrackSelector" class="select-menu" title="Audio Language">
                <option value="">ðŸŽµ Audio tracks</option>
            </select>

            <!-- Picture-in-Picture -->
            <button class="control-btn pip-btn" id="pipBtn" title="Picture-in-Picture">
                <span class="material-icons">picture_in_picture_alt</span>
            </button>

            <!-- Fullscreen custom -->
            <button class="control-btn fullscreen-btn" id="fullscreenBtn" title="Fullscreen">
                <span class="material-icons">fullscreen</span>
            </button>

            <!-- DRM status badge (ClearKey active) -->
            <span class="drm-badge" id="drmBadge">
                <span class="material-icons" style="font-size: 14px;">verified</span> ClearKey DRM
            </span>
        </div>
    </div>
</div>

<script>
    (function(){
        "use strict";

        // ==============================
        // ðŸ”¹ YOUR DRM CLEARKEY DETAILS
        // ==============================
        var mpdUrl = "https://jiotvpllive.cdn.jio.com/bpk-tv/Star_Sports_HD1_Hindi_BTS/output/index.mpd";
        var keyId = "400131994b445d8c8817202248760fda";
        var key   = "2d56cb6f07a75b9aff165d534ae2bfc4";

        // ---------- DOM elements ----------
        const video = document.getElementById('videoPlayer');
        const wrapper = document.getElementById('playerWrapper');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const timeDisplay = document.getElementById('timeDisplay');
        const seekBar = document.getElementById('seekBar');
        const seekProgress = document.getElementById('seekProgress');
        const volumeSlider = document.getElementById('volumeSlider');
        const muteBtn = document.getElementById('muteBtn');
        const qualitySelector = document.getElementById('qualitySelector');
        const audioTrackSelector = document.getElementById('audioTrackSelector');
        const pipBtn = document.getElementById('pipBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const liveIndicator = document.getElementById('liveIndicator');

        // ---------- DASH.JS INIT ----------
        const player = dashjs.MediaPlayer().create();

        // DRM Protection (ClearKey)
        player.setProtectionData({
            "org.w3.clearkey": {
                "clearkeys": {
                    [keyId]: key
                }
            }
        });

        // BUFFER & LIVE OPTIMIZATION (improved)
        player.updateSettings({
            'streaming': {
                'liveDelay': 5,                // lower delay for live
                'liveCatchUpMaxDrift': 2,
                'liveCatchUpPlaybackRate': 1.05,
                'buffer': {
                    'fastSwitchEnabled': true,    // immediate quality switch
                    'bufferTimeAtTopQuality': 12, // keep higher buffer for 1080p
                    'bufferTimeAtTopQualityLongForm': 15,
                    'stallThreshold': 0.5,
                },
                'abr': {
                    'autoSwitchBitrate': true,    // ENABLE auto by default
                    'enableBufferBasedABR': true,
                    'useDefaultABRRules': true,
                }
            }
        });

        // Initialize player
        player.initialize(video, mpdUrl, true);

        // ---------- AUTO PLAY (muted autoplay policy) ----------
        video.autoplay = false;   
        video.muted = false;      // audio unmuted // most browsers allow autoplay muted
        // we unmute later if user interacts

        // ---------- GLOBAL VARIABLES ----------
        let isSeeking = false;
        let isLive = false;

        // ---------- HELPER FUNCTIONS ----------
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds === Infinity) return '00:00';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            if (h > 0) return `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            return `${m}:${s.toString().padStart(2,'0')}`;
        }

        // Update UI time + seekbar
        function updateTimeUI() {
            if (!video.duration || isSeeking) return;
            const current = video.currentTime || 0;
            const duration = video.duration || 0;
            timeDisplay.innerText = `${formatTime(current)} / ${formatTime(duration)}`;
            const percent = (current / duration) * 100 || 0;
            seekProgress.style.width = percent + '%';
        }

        // ---------- DETECT LIVE ----------
        player.on(dashjs.MediaPlayer.events.STREAM_INITIALIZED, () => {
            // check if manifest is live
            isLive = player.isDynamic();
            if (isLive) {
                liveIndicator.style.display = 'inline-flex';
                timeDisplay.style.opacity = '0.7';
                // live optimization: set target latency
                player.setLiveDelay(4);
            } else {
                liveIndicator.style.display = 'none';
            }
        });

        // ---------- POPULATE QUALITY OPTIONS (manual 144p to 1080p) ----------
        function populateQualityOptions() {
            // wait for bitrates
            setTimeout(() => {
                try {
                    const tracks = player.getBitrateInfoListFor('video');
                    if (tracks && tracks.length) {
                        // keep auto
                        qualitySelector.innerHTML = '<option value="auto">ðŸ”¹ Auto (adaptive)</option>';
                        // sort by height desc (1080p ... 144p)
                        const sorted = tracks.sort((a,b) => (b.height || 0) - (a.height || 0));
                        sorted.forEach((track, idx) => {
                            const height = track.height || (track.bitrate ? Math.round(track.bitrate/1000)+'k' : 'SD');
                            const label = track.height ? `${track.height}p` : `Bitrate ${Math.round(track.bitrate/1000)}kbps`;
                            const option = document.createElement('option');
                            option.value = track.qualityIndex || idx; 
                            option.textContent = label + (track.height >= 720 ? ' HD' : '');
                            qualitySelector.appendChild(option);
                        });
                    } else {
                        // fallback manual qualities (144p .. 1080p) as many streams provide bitrate list later
                        fallbackQualities();
                    }
                } catch (e) {
                    fallbackQualities();
                }
            }, 800);
        }

        function fallbackQualities() {
            qualitySelector.innerHTML = '<option value="auto">ðŸ”¹ Auto (adaptive)</option>';
            const manual = [1080, 720, 480, 360, 240, 144];
            manual.forEach(h => {
                const opt = document.createElement('option');
                opt.value = h;
                opt.textContent = h + 'p';
                qualitySelector.appendChild(opt);
            });
        }

        // ---------- QUALITY CHANGE HANDLER ----------
        qualitySelector.addEventListener('change', function(e) {
            const val = e.target.value;
            if (val === 'auto') {
                player.setAutoSwitchQualityFor('video', true);
                // also enable ABR
                player.updateSettings({'streaming': {'abr': {'autoSwitchBitrate': true}}});
            } else {
                // manual quality: disable auto-switch and set track
                player.setAutoSwitchQualityFor('video', false);
                const qualityIndex = parseInt(val, 10);
                // if it's bitrate list index
                if (!isNaN(qualityIndex)) {
                    player.setQualityFor('video', qualityIndex);
                } else {
                    // fallback: we can't directly set by height, but dashjs uses index. we use abr to limit?
                    // for fallback: set max bitrate? better: use setQualityFor with index. we assume index works.
                }
            }
        });

        // ---------- POPULATE AUDIO TRACKS (multi-language) ----------
        player.on(dashjs.MediaPlayer.events.STREAM_INITIALIZED, function() {
            setTimeout(() => {
                const audioTracks = player.getTracksFor('audio');
                if (audioTracks && audioTracks.length > 1) {
                    audioTrackSelector.innerHTML = '<option value="">ðŸŽ§ Select Audio</option>';
                    audioTracks.forEach((track, idx) => {
                        const lang = track.lang || track.label || `Track ${idx+1}`;
                        const opt = document.createElement('option');
                        opt.value = idx;
                        opt.textContent = `${lang} (${track.codec ? track.codec.slice(0,5) : 'audio'})`;
                        audioTrackSelector.appendChild(opt);
                    });
                } else {
                    audioTrackSelector.innerHTML = '<option value="">ðŸŽµ Audio (default)</option>';
                }
            }, 600);
        });

        // Switch audio track
        audioTrackSelector.addEventListener('change', function(e) {
            const idx = parseInt(e.target.value, 10);
            if (!isNaN(idx)) {
                const tracks = player.getTracksFor('audio');
                if (tracks && tracks[idx]) {
                    player.setCurrentTrack(tracks[idx]);
                }
            }
        });

        // ---------- CUSTOM PLAY/PAUSE ----------
        playPauseBtn.addEventListener('click', () => {
            if (video.paused) {
                video.play();
                playPauseBtn.innerHTML = '<span class="material-icons">pause</span>';
            } else {
                video.pause();
                playPauseBtn.innerHTML = '<span class="material-icons">play_arrow</span>';
            }
        });

        video.addEventListener('play', () => playPauseBtn.innerHTML = '<span class="material-icons">pause</span>');
        video.addEventListener('pause', () => playPauseBtn.innerHTML = '<span class="material-icons">play_arrow</span>');

        // ---------- VOLUME + MUTE ----------
        volumeSlider.addEventListener('input', (e) => {
            video.volume = parseFloat(e.target.value);
            video.muted = false;
            updateMuteIcon();
        });

        muteBtn.addEventListener('click', () => {
            video.muted = !video.muted;
            updateMuteIcon();
        });

        function updateMuteIcon() {
            if (video.muted || video.volume === 0) {
                muteBtn.innerHTML = '<span class="material-icons">volume_off</span>';
                volumeSlider.value = 0;
            } else {
                muteBtn.innerHTML = '<span class="material-icons">volume_up</span>';
                volumeSlider.value = video.volume;
            }
        }

        video.addEventListener('volumechange', updateMuteIcon);

        // ---------- SEEK BAR ----------
        seekBar.addEventListener('mousedown', (e) => { isSeeking = true; });
        window.addEventListener('mouseup', (e) => { isSeeking = false; });

        seekBar.addEventListener('click', (e) => {
            const rect = seekBar.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            video.currentTime = percent * video.duration;
        });

        video.addEventListener('timeupdate', updateTimeUI);
        video.addEventListener('loadedmetadata', updateTimeUI);

        // ---------- PICTURE-IN-PICTURE ----------
        pipBtn.addEventListener('click', async () => {
            try {
                if (document.pictureInPictureElement) {
                    await document.exitPictureInPicture();
                } else {
                    await video.requestPictureInPicture();
                }
            } catch (err) {
                console.warn('PiP error:', err);
            }
        });

        // ---------- FULLSCREEN (custom) ----------
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                wrapper.requestFullscreen();
                wrapper.classList.add('fullscreen');
                fullscreenBtn.innerHTML = '<span class="material-icons">fullscreen_exit</span>';
            } else {
                document.exitFullscreen();
                wrapper.classList.remove('fullscreen');
                fullscreenBtn.innerHTML = '<span class="material-icons">fullscreen</span>';
            }
        }

        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                wrapper.classList.remove('fullscreen');
                fullscreenBtn.innerHTML = '<span class="material-icons">fullscreen</span>';
            }
        });

        // ---------- DRM STATUS BADGE (just visual) ----------
        // Already static. We can update if error
        player.on(dashjs.MediaPlayer.events.KEY_SYSTEM_SELECTED, (e) => {
            document.getElementById('drmBadge').innerHTML = '<span class="material-icons" style="font-size:14px;">lock</span> DRM active';
        });

        // ---------- LOAD QUALITY & AUDIO ON READY ----------
        player.on(dashjs.MediaPlayer.events.MANIFEST_LOADED, () => {
            populateQualityOptions();
        });

        // ---------- INITIAL UI ----------
        window.onload = function() {
            // set volume default
            video.volume = 1;
            video.muted = false;   // but we set autoplay muted? to allow unmuted after interaction
            // to enable unmuted autoplay we need user gesture. we set muted=false but autoplay may fail.
            // safer: autoplay with muted, but we let user unmute
            video.muted = true;   // consistent: start muted
            volumeSlider.value = 1;
            updateMuteIcon();
            // manually trigger auto quality enabled
            player.setAutoSwitchQualityFor('video', true);
        };

        // if live, set catch up
        video.addEventListener('play', () => {
            if (isLive) {
                // dash live settings
            }
        });

        // ---------- FALLBACK FOR AUTO PLAY (ensure it tries) ----------
        video.play().catch(e => {
            // autoplay prevented, show play button
            playPauseBtn.innerHTML = '<span class="material-icons">play_arrow</span>';
        });

    })();
</script>

<!-- tiny note: clearKey works with hex pair. Ensure dashjs parses clearkeys correctly. -->
</body>
</html>
